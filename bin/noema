#!/bin/bash
# noema CLI helper with subcommands
# Can be called directly: noema tui, noema cli, etc.

set -e

# Get the script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# ============================================================================
# Subcommands
# ============================================================================

noema_tui() {
    cargo run --manifest-path "$REPO_ROOT/Cargo.toml" -p tui -- "$@"
}

noema_cli() {
    cargo run --manifest-path "$REPO_ROOT/Cargo.toml" -p cli -- "$@"
}

noema_gui() {
    cargo run --manifest-path "$REPO_ROOT/Cargo.toml" -p noema-app -- "$@"
}

noema_build() {
    echo "Building noema..."
    cargo build --manifest-path "$REPO_ROOT/Cargo.toml" --release
    echo ""
    echo "Binaries available at:"
    echo "  $REPO_ROOT/target/release/tui"
    echo "  $REPO_ROOT/target/release/cli"
    echo "  $REPO_ROOT/target/release/noema-app"
}

noema_help() {
    cat <<EOF
Noema CLI Helper

Usage: noema <command> [options]

Commands:
  tui [options]       Run the TUI chat interface (default)
  cli [options]       Run the CLI chat interface
  gui                 Run the native GUI (Bevy/egui)
  build               Build release binaries
  help                Show this help message

TUI/CLI Options:
  --model <provider>        Model provider: ollama, gemini, claude, openai (default: gemini)
  --mode <mode>             Chat mode: chat, stream (default: stream)
  --system-message <msg>    Set a custom system message
  -t, --tracing             Enable tracing output
  --openai-url <url>        Custom OpenAI API base URL
  --claude-url <url>        Custom Claude API base URL
  --gemini-url <url>        Custom Gemini API base URL
  --ollama-url <url>        Custom Ollama API base URL

Environment Variables:
  OPENAI_BASE_URL           OpenAI API base URL
  CLAUDE_BASE_URL           Claude API base URL
  GEMINI_BASE_URL           Gemini API base URL
  OLLAMA_BASE_URL           Ollama API base URL
  OPENAI_API_KEY            OpenAI API key
  CLAUDE_API_KEY            Claude/Anthropic API key
  GEMINI_API_KEY            Gemini API key

Examples:
  # Run TUI with default settings
  noema tui

  # Run CLI with Claude
  noema cli --model claude

  # Run TUI through a proxy
  noema tui --gemini-url http://localhost:8888/gemini

  # Run CLI with streaming disabled
  noema cli --mode chat

  # Run the native GUI
  noema gui

EOF
}

# ============================================================================
# Main command dispatcher
# ============================================================================

# Export list of available commands (for meta-wrapper discovery)
noema_commands() {
    echo "tui cli gui build help"
}

# ============================================================================
# Completion Support
# ============================================================================

noema_complete() {
    local position="$1"
    shift
    local -a words=("$@")

    # Position 1: complete subcommand
    if [ "$position" -eq 1 ]; then
        noema_commands
        return
    fi

    # Position 2+: complete arguments based on subcommand
    local subcommand="${words[0]}"

    case "$subcommand" in
        tui|cli)
            echo "--model --mode --system-message -t --tracing --openai-url --claude-url --gemini-url --ollama-url"
            ;;
    esac
}

# Main entry point when called directly
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    cmd="${1:-tui}"
    shift || true

    case "$cmd" in
        commands)
            noema_commands
            ;;
        complete)
            noema_complete "$@"
            ;;
        tui|cli|gui|build|help)
            "noema_$cmd" "$@"
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'noema help' for usage"
            exit 1
            ;;
    esac
fi
