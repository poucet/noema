#!/bin/bash
# noema CLI helper with subcommands

set -e

# Get the script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# ============================================================================
# Subcommands
# ============================================================================


noema_gui() {
    # Use a local log file that gets cleared on each run
    local LOG_FILE="$REPO_ROOT/noema.log"

    # Clear the log file
    : > "$LOG_FILE"

    echo "Traffic log: $LOG_FILE"

    # Export the log file path as an environment variable
    export NOEMA_LOG_FILE="$LOG_FILE"

    cd "$REPO_ROOT/noema-desktop" && npm run tauri dev "$@"
}

noema_build() {
    echo "Building Tauri GUI..."
    cd "$REPO_ROOT/noema-desktop" && npm run tauri build
    echo ""
    echo "Binaries available at:"
    echo "  $REPO_ROOT/noema-desktop/src-tauri/target/release/bundle/"
}

noema_install() {
    echo "Building Noema..."
    cd "$REPO_ROOT/noema-desktop" && npm run tauri build

    echo "Opening Noema installer..."
    open "$REPO_ROOT/noema-desktop/src-tauri/target/release/bundle/dmg/Noema_0.1.0_aarch64.dmg"
}

noema_help() {
    cat <<EOF
Noema CLI Helper

Usage: noema <command> [options]

Commands:
  gui                 Run the Tauri GUI (React + web)
  build               Build release binaries
  install             Open the macOS installer (.dmg)
  help                Show this help message

Environment Variables:
  OPENAI_BASE_URL           OpenAI API base URL
  CLAUDE_BASE_URL           Claude API base URL
  GEMINI_BASE_URL           Gemini API base URL
  OLLAMA_BASE_URL           Ollama API base URL
  OPENAI_API_KEY            OpenAI API key
  CLAUDE_API_KEY            Claude/Anthropic API key
  GEMINI_API_KEY            Gemini API key

Examples:
  # Run the Tauri GUI
  noema gui

EOF
}

# ============================================================================
# Main command dispatcher
# ============================================================================

# Export list of available commands (for meta-wrapper discovery)
noema_commands() {
    echo "gui build install help"
}

# ============================================================================
# Completion Support
# ============================================================================

noema_complete() {
    local position="$1"
    shift
    local -a words=("$@")

    # Position 1: complete subcommand
    if [ "$position" -eq 1 ]; then
        noema_commands
        return
    fi

    # Position 2+: complete arguments based on subcommand
    local subcommand="${words[0]}"

    case "$subcommand" in
    esac
}

# Main entry point when called directly
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    cmd="${1:-gui}"
    shift || true

    case "$cmd" in
        commands)
            noema_commands
            ;;
        complete)
            noema_complete "$@"
            ;;
        gui|build|install|help)
            "noema_$cmd" "$@"
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'noema help' for usage"
            exit 1
            ;;
    esac
fi
